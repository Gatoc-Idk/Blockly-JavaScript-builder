<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blockly JavaScript Builder</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
  <script src="https://unpkg.com/blockly/msg/en.js"></script>
  <script src="https://unpkg.com/blockly/zelos.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #main {
      display: flex;
      flex: 1;
    }
    #blocklyDiv {
      height: 100%;
      width: 60%;
    }
    #rightPanel {
      width: 40%;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #ccc;
      background: #f9f9f9;
    }
    #codeHeader {
      padding: 10px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #ccc;
    }
    #codeArea {
      flex: 1;
      padding: 10px;
      overflow: auto;
    }
    #codeArea pre {
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    #buttons {
      padding: 10px;
      border-top: 1px solid #ccc;
      background: #fff;
    }
    button, label[for="loadFile"] {
      margin-right: 10px;
      padding: 5px 10px;
      cursor: pointer;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: inline-block;
    }
    #output {
      margin-top: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    #errorMessage {
      margin-top: 5px;
      color: red;
      font-family: monospace;
    }
    #settingsPanel {
      display: none;
      justify-content: center;
      gap: 10px;
      margin: 10px;
    }
    #loopControls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #loopInterval {
      width: 80px;
      padding: 4px;
    }
  </style>
</head>
<body>

  <!-- Header and Settings Button -->
  <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 10px;">
    <h2 style="margin: 0;">Blockly JavaScript Builder</h2>
    <button id="settingsButton">‚öôÔ∏è Settings</button>
  </div>

  <!-- Settings Panel -->
  <div id="settingsPanel">
    <button id="themeToggle">üé® Toggle Theme</button>
    <button onclick="saveWorkspace()">üíæ Save</button>
    <label for="loadFile">üìÇ Load</label>
    <input type="file" id="loadFile" accept=".xml" style="display: none;" />
  </div>

  <div id="main">
    <div id="blocklyDiv"></div>
    <div id="rightPanel">
      <div id="codeHeader">
        <h4 style="margin: 0;">üìÑ JavaScript Code</h4>
        <div id="loopControls">
          <input id="loopInterval" type="number" value="1000" min="100" />ms
          <button onclick="runCode()">‚ñ∂ Run</button>
          <button onclick="startLoop()">üîÅ Loop Run</button>
          <button onclick="stopLoop()">‚èπ Stop</button>
        </div>
      </div>
      <div id="codeArea">
        <pre id="code"></pre>
      </div>
      <div id="buttons">
        <button onclick="updateCode()">üîÑ Update</button>
        <button onclick="copyCode()">üìã Copy Code</button>
        <div id="output"></div>
        <div id="errorMessage"></div>
      </div>
    </div>
  </div>

  <!-- Toolbox -->
  <xml id="toolbox" style="display: none">
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_boolean"></block>
      <block type="logic_negate"></block>
      <block type="logic_null"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_number"><field name="NUM">0</field></block>
      <block type="math_arithmetic"></block>
      <block type="math_round"></block>
      <block type="math_single"></block>
      <block type="math_modulo"></block>
      <block type="math_random_int"></block>
    </category>
    <category name="Lists" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat"></block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_getSublist"></block>
      <block type="lists_split"></block>
      <block type="lists_sort"></block>
    </category>
    <category name="Text" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <block type="text_print"></block>
      <block type="text_prompt"></block>
      <block type="text_length"></block>
      <block type="text_isEmpty"></block>
      <block type="text_join"></block>
    </category>
    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil">
        <field name="MODE">WHILE</field>
      </block>
    </category>
    <category name="Variables" custom="VARIABLE" colour="%{BKY_VARIABLES_HUE}"></category>
    <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}"></category>
  </xml>

  <script>
    Blockly.Themes.ScratchBright = Blockly.Theme.defineTheme('scratchTheme', {
      base: Blockly.Themes.Classic,
      blockStyles: {
        logic_blocks: { colourPrimary: '#5C81A6' },
        math_blocks: { colourPrimary: '#5C68A6' },
        text_blocks: { colourPrimary: '#5CA68D' },
        list_blocks: { colourPrimary: '#745CA6' },
        variable_blocks: { colourPrimary: '#A65C81' },
        procedure_blocks: { colourPrimary: '#8000ff' }
      },
      fontStyle: {
        family: 'Helvetica, Arial, sans-serif',
        size: 10
      },
      startHats: true
    });

    let usingScratchTheme = true;
    let workspace;

    function createWorkspace(theme, renderer) {
      if (workspace) workspace.dispose();
      workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        scrollbars: true,
        theme,
        renderer,
        zoom: {
          controls: true,
          wheel: true,
          startScale: 1.0,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2,
          pinch: true
        },
        trashcan: true
      });
      workspace.addChangeListener(updateCode);
      updateCode();
    }

    createWorkspace(Blockly.Themes.ScratchBright, 'zelos');

    document.getElementById('themeToggle').addEventListener('click', () => {
      const confirmChange = window.confirm("Are you sure you want to change themes? This will delete your code.");
      if (confirmChange) {
        usingScratchTheme = !usingScratchTheme;
        createWorkspace(
          usingScratchTheme ? Blockly.Themes.ScratchBright : Blockly.Themes.Classic,
          usingScratchTheme ? 'zelos' : 'geras'
        );
      }
    });

    document.getElementById('settingsButton').addEventListener('click', () => {
      const panel = document.getElementById('settingsPanel');
      panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
    });

    function updateCode() {
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      document.getElementById('code').textContent = code;
    }

    function runCode() {
      updateCode();
      const code = document.getElementById('code').textContent;
      const outputDiv = document.getElementById('output');
      const errorDiv = document.getElementById('errorMessage');
      outputDiv.textContent = "";
      errorDiv.textContent = "";
      try {
        (async () => { await eval(`(async () => {\n${code}\n})()`); })();
      } catch (e) {
        errorDiv.innerText = "‚ùå Error: " + e.message;
      }
    }

    function copyCode() {
      const code = document.getElementById('code').textContent;
      navigator.clipboard.writeText(code)
        .then(() => alert("Code copied to clipboard!"))
        .catch(err => alert("Failed to copy code: " + err));
    }

    let loopInterval = null;

    function startLoop() {
      stopLoop();
      updateCode();
      const code = document.getElementById('code').textContent;
      const outputDiv = document.getElementById('output');
      const errorDiv = document.getElementById('errorMessage');
      const interval = parseInt(document.getElementById('loopInterval').value) || 1000;
      outputDiv.textContent = "";
      errorDiv.textContent = "";
      try {
        loopInterval = setInterval(() => {
          try {
            errorDiv.textContent = "";
            (async () => { await eval(`(async () => {\n${code}\n})()`); })();
          } catch (e) {
            outputDiv.textContent = "";
            errorDiv.textContent = "‚ùå Loop Error: " + e.message;
            stopLoop();
          }
        }, interval);
      } catch (e) {
        errorDiv.textContent = "‚ùå Setup Error: " + e.message;
      }
    }

    function stopLoop() {
      if (loopInterval) {
        clearInterval(loopInterval);
        loopInterval = null;
        document.getElementById('output').textContent += "\n‚èπ Loop stopped.";
        document.getElementById('errorMessage').textContent = "";
      }
    }

    function saveWorkspace() {
      const xml = Blockly.Xml.workspaceToDom(workspace);
      const xmlText = Blockly.Xml.domToPrettyText(xml);
      const blob = new Blob([xmlText], { type: 'text/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'blockly_workspace.xml';
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('loadFile').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const xmlText = e.target.result;
        try {
          const xml = Blockly.utils.xml.textToDom(xmlText);
          Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
        } catch (err) {
          alert("‚ùå Failed to load workspace: " + err.message);
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
